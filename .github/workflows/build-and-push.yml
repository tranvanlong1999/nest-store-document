name: Build and Push to Harbor

on:
  workflow_dispatch:  # Manual trigger for testing
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'

env:
  HARBOR_REGISTRY: harbor-dev.helix.io
  HARBOR_PROJECT: frontend
  IMAGE_NAME: helix-core-document

jobs:
  build-and-push:
    runs-on: k3s-runner-helix

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set image tags
        id: meta
        run: |
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)

          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "timestamp=${TIMESTAMP}" >> $GITHUB_OUTPUT
          echo "image_base=${HARBOR_REGISTRY}/${HARBOR_PROJECT}/${IMAGE_NAME}" >> $GITHUB_OUTPUT

      - name: Login to Harbor
        run: |
          echo "üîê Logging in to Harbor registry..."
          echo 'Harbor12345' | docker login ${HARBOR_REGISTRY} -u admin --password-stdin

      - name: Configure Docker daemon for insecure registry
        run: |
          # Configure Docker daemon for insecure registry
          sudo mkdir -p /etc/docker

          # Backup existing daemon.json if exists
          if [ -f /etc/docker/daemon.json ]; then
            sudo cp /etc/docker/daemon.json /etc/docker/daemon.json.backup
          fi

          # Create or update daemon.json
          cat <<EOF | sudo tee /etc/docker/daemon.json
          {
            "insecure-registries": ["${HARBOR_REGISTRY}"]
          }
          EOF

          # Reload Docker daemon
          sudo systemctl reload docker || sudo service docker restart

          echo "‚úÖ Docker daemon configured for insecure registry"

      - name: Setup Docker Buildx
        run: |
          echo "üîß Setting up Docker Buildx..."

          # Create buildx builder with insecure registry config
          docker buildx create \
            --name harbor-builder \
            --driver docker-container \
            --driver-opt network=host \
            --buildkitd-flags '--allow-insecure-entitlement security.insecure' \
            --use

          # Configure buildx for insecure registry
          docker buildx inspect --bootstrap

          echo "‚úÖ Docker Buildx configured"

      - name: Build and push with Buildx
        run: |
          IMAGE_BASE="${{ steps.meta.outputs.image_base }}"
          SHORT_SHA="${{ steps.meta.outputs.short_sha }}"

          echo "üî® Building Docusaurus image with Buildx..."
          echo "üì¶ Destination: ${IMAGE_BASE}:${SHORT_SHA}"

          # Build and push image
          docker buildx build \
            --platform linux/amd64 \
            --tag ${IMAGE_BASE}:${SHORT_SHA} \
            --tag ${IMAGE_BASE}:latest \
            --push \
            --provenance=false \
            --allow security.insecure \
            .

      - name: Cleanup Buildx
        if: always()
        run: |
          echo "üßπ Cleaning up Buildx builder..."
          docker buildx rm harbor-builder || true

      - name: Verify image
        run: |
          IMAGE="${{ steps.meta.outputs.image_base }}:latest"

          echo "‚úÖ Build completed successfully!"
          echo ""
          echo "üîç Verifying image in Harbor..."

          # Pull image to verify
          docker pull ${IMAGE}

          # Show image details
          echo ""
          echo "üìä Image details:"
          docker images ${IMAGE} --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}\t{{.CreatedAt}}"

          echo ""
          echo "üè∑Ô∏è  Available tags:"
          echo "  ‚Ä¢ ${{ steps.meta.outputs.image_base }}:${{ steps.meta.outputs.short_sha }}"
          echo "  ‚Ä¢ ${{ steps.meta.outputs.image_base }}:latest"

      - name: Deployment info
        run: |
          echo "üìã Deployment Information"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo ""
          echo "üîó Harbor Registry: http://${HARBOR_REGISTRY}"
          echo "üìÇ Project: ${HARBOR_PROJECT}"
          echo "üñºÔ∏è  Image: ${IMAGE_NAME}"
          echo "üè∑Ô∏è  Tag: ${{ steps.meta.outputs.short_sha }}"
          echo ""
          echo "üöÄ To deploy this image:"
          echo "   docker run -d -p 3000:3000 \\"
          echo "     ${{ steps.meta.outputs.image_base }}:${{ steps.meta.outputs.short_sha }}"
          echo ""
          echo "üîß Or update your K8s deployment:"
          echo "   kubectl set image deployment/docs \\"
          echo "     docs=${{ steps.meta.outputs.image_base }}:${{ steps.meta.outputs.short_sha }}"
